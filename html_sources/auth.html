<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auth</title>
</head>
<body class="container">
<p class="lead">Welcome to the Chat</p>

<p><b>Login</b>
    <label>
        <input type="text" id="login"/>
    </label></p>

<p><b>Password</b>
    <label>
        <input type="password" id="password"/>
    </label></p>
<button onclick="logBtn()" name="log">Log in</button>
<button onclick="regBtn()" name="reg">Register</button>
<script>
    function logBtn() {
        var login = document.getElementById("login").value;
        var password = document.getElementById("password").value;

        var origin = window.location.origin;

        /**
         * This block of promises takes a login and session ID,
         * send them to the server
         * gets response
         * If this response contains route to the chat
         * user redirects automatically
         * Else from response extracted salt
         * Then to the server sends request with login and hashed password+salt
         * If all data is correct, user redirected to chat
         */
        getSalt(login)
            .then(function(data) {
                if (!data) {
                    document.getElementById("login").value = "";
                    document.getElementById("password").value = "";
                    //TODO: message about the absence of a user in db

                }
                else {
                    authCheck(login, sha(password, data))
                        .then(function(data1) {
                            window.location.replace(origin + data1);
                        })
                        .catch(function (err1) {
                            if (err1 == 401) {
                                document.getElementById("login").value = "";
                                document.getElementById("password").value = "";
                                //TODO: show message about incorrect login or password

                            } else {
                                window.location.replace(origin + '/error');

                            }
                        })
                }
            })
            .catch(function(err) {
                window.location.replace(origin + '/error');
            });
    }
    function regBtn() {
         window.location.replace(window.location.origin + '/reg');
    }
</script>
<script>
    function getSalt(login) {
        return new Promise(function(response, reject) {
            var xhr = new XMLHttpRequest();

            xhr.open("POST", '/auth/connect', true);

            xhr.send(JSON.stringify({ "login": login }));

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        response(this.responseText);

                    } else {
                        reject(xhr.status);

                    }
                }
            };

            xhr.onabort = function() {
                reject(xhr.status);
            }
        })
    }
</script>
<script>
    function authCheck(login, password) {
        return new Promise(function(response, reject) {
            var xhr = new XMLHttpRequest();

            xhr.open("POST", '/auth/enter', true);

            xhr.send(JSON.stringify({ "login": login, "password": password }));

            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        response(this.responseText);

                    } else {
                        reject(xhr.status);

                    }
                }
            };
            
            xhr.onabort = function() {
                reject(xhr.status);
            }
        })
    }
</script>
<script>
    function getCookie(name) {
        var matches = document.cookie.match(new RegExp(
            "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1')
            + "=([^;]*)"
        ));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }
</script>
<script>
    function sha(password, salt) {
        var n = salt.substr(0, 1);
        salt = salt.substr(1, salt.length - 1);

        for (var i = 0; i < n; i++)
            password = password + salt; //stub
            //password = sha3(password + salt)
        return password;
        //TODO: import keccak512 from server
    }
</script>
</body>
</html>